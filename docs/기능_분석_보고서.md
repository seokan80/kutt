# Kutt URL Shortener 기능 분석 보고서

## 프로젝트 개요

**Kutt**는 Node.js 기반의 현대적인 URL 단축 서비스입니다. 커스텀 도메인 지원, 통계 분석, 사용자 관리 등 다양한 기능을 제공하는 오픈소스 프로젝트입니다.

### 기본 정보
- **프로젝트명**: Kutt
- **버전**: 3.2.3
- **라이선스**: MIT
- **언어**: JavaScript (Node.js)
- **리포지토리**: https://github.com/thedevs-network/kutt

---

## 아키텍처 분석

### 1. 전체 구조

```
kutt/
├── server/           # 백엔드 서버 코드
│   ├── handlers/     # 비즈니스 로직 처리
│   ├── routes/       # API 라우팅
│   ├── models/       # 데이터베이스 스키마
│   ├── migrations/   # 데이터베이스 마이그레이션
│   ├── views/        # 템플릿 파일 (HBS)
│   ├── utils/        # 유틸리티 함수
│   ├── queues/       # 백그라운드 작업 큐
│   └── mail/         # 이메일 관련 기능
├── static/           # 정적 파일 (CSS, JS, 이미지)
├── custom/           # 커스터마이징 파일
├── docs/             # 문서
└── db/               # SQLite 데이터베이스 (기본값)
```

### 2. 기술 스택

#### 백엔드
- **웹 프레임워크**: Express.js
- **인증**: Passport.js (JWT, Local Strategy)
- **데이터베이스 ORM**: Knex.js
- **템플릿 엔진**: Handlebars (HBS)
- **비밀번호 해싱**: bcryptjs
- **큐 시스템**: Bull (Redis 기반)

#### 데이터베이스 지원
- SQLite (기본값)
- PostgreSQL
- MySQL/MariaDB

#### 캐싱 & 큐
- Redis (선택사항)

---

## 주요 기능 분석

### 1. URL 단축 기능 (`server/handlers/links.handler.js`)

#### 핵심 기능
- **단축 URL 생성**: 랜덤 또는 커스텀 주소 생성
- **리디렉션**: 단축 URL을 원본 URL로 리디렉션
- **만료 시간 설정**: 링크에 만료 시간 지정 가능
- **비밀번호 보호**: 보호된 링크 생성 가능

#### 주소 생성 알고리즘
```javascript
// 기본 알파벳 (혼동 방지를 위해 특정 문자 제외)
LINK_CUSTOM_ALPHABET: "abcdefghkmnpqrstuvwxyzABCDEFGHKLMNPQRSTUVWXYZ23456789"
LINK_LENGTH: 6 (기본값)
```

### 2. 사용자 관리 시스템

#### 사용자 역할
- **USER**: 일반 사용자
- **ADMIN**: 관리자 (모든 링크 관리 권한)

#### 인증 방식
1. **JWT 토큰**: 웹 인터페이스용
2. **API 키**: API 접근용
3. **세션 쿠키**: 브라우저 세션 관리

#### 사용자 기능
- 회원가입/로그인
- 이메일 인증
- 비밀번호 재설정
- API 키 생성/관리
- 프로필 설정

### 3. 도메인 관리 (`server/handlers/domains.handler.js`)

#### 커스텀 도메인 지원
- 사용자별 커스텀 도메인 등록
- 도메인별 HTTP/HTTPS 설정
- 도메인 소유권 확인

### 4. 통계 및 분석 (`server/models/visit.model.js`)

#### 방문 통계 데이터
- **방문 횟수**: 링크별 클릭 수 추적
- **지리적 정보**: IP 기반 국가/지역 정보
- **브라우저 정보**: User-Agent 분석
- **참조 페이지**: Referrer 정보
- **시간대별 분석**: 방문 시간 패턴

#### 개인정보 보호
- IP 주소 해싱 처리
- 익명화된 통계 데이터

### 5. 관리자 기능

#### 링크 관리
- 모든 사용자 링크 조회/편집/삭제
- 링크 금지 (ban) 기능
- 사용자 금지 기능

#### 시스템 관리
- 사용자 관리
- 시스템 설정
- 통계 대시보드

---

## 데이터베이스 구조

### 주요 테이블

#### 1. `users` 테이블
```sql
- id (PK)
- email (UNIQUE)
- password
- role (USER/ADMIN)
- apikey
- banned
- verified
- reset_password_token
- change_email_token
- verification_token
- timestamps
```

#### 2. `links` 테이블
```sql
- id (PK)
- address (단축 주소)
- target (원본 URL)
- description
- password
- expire_in
- user_id (FK)
- domain_id (FK)
- visit_count
- banned
- uuid
- timestamps
```

#### 3. `visits` 테이블
```sql
- id (PK)
- link_id (FK)
- user_id (FK)
- ip (해싱됨)
- country
- referrer
- browser
- os
- timestamps
```

#### 4. `domains` 테이블
```sql
- id (PK)
- address
- homepage
- user_id (FK)
- banned
- timestamps
```

### 인덱스 최적화
- `links.address` - 단축 URL 조회 최적화
- `visits.link_id` - 통계 조회 최적화
- `visits.user_id` - 사용자별 통계 최적화

---

## API 구조

### 인증 엔드포인트 (`/api/auth`)
```
POST /login          - 로그인
POST /signup         - 회원가입
POST /create-admin   - 관리자 계정 생성
POST /change-password - 비밀번호 변경
POST /change-email   - 이메일 변경
POST /apikey         - API 키 생성
POST /reset-password - 비밀번호 재설정
POST /new-password   - 새 비밀번호 설정
```

### 링크 관리 엔드포인트 (`/api/links`)
```
GET    /             - 링크 목록 조회
POST   /             - 링크 생성
PATCH  /:id          - 링크 수정
DELETE /:id          - 링크 삭제
GET    /:id/stats    - 링크 통계 조회
POST   /:id/protected - 보호된 링크 접근
POST   /report       - 링크 신고
```

### 관리자 엔드포인트
```
GET    /admin        - 관리자 링크 목록
PATCH  /admin/:id    - 관리자 링크 수정
POST   /admin/ban/:id - 링크 금지
```

### 사용자 관리 엔드포인트 (`/api/users`)
```
GET    /             - 사용자 정보 조회
PATCH  /             - 사용자 정보 수정
DELETE /             - 계정 삭제
```

### 도메인 관리 엔드포인트 (`/api/domains`)
```
GET    /             - 도메인 목록 조회
POST   /             - 도메인 추가
DELETE /:id          - 도메인 삭제
```

---

## 보안 기능

### 1. 인증 & 인가
- **JWT 토큰**: 상태 없는 인증
- **API 키**: API 접근 제어
- **비밀번호 해싱**: bcryptjs 사용
- **역할 기반 접근 제어**: USER/ADMIN 역할 구분

### 2. 보안 미들웨어
- **Helmet**: HTTP 헤더 보안
- **CORS**: 교차 출처 리소스 공유 제어
- **Rate Limiting**: API 호출 제한
- **Input Validation**: express-validator 사용

### 3. 데이터 보호
- **IP 주소 해싱**: 개인정보 보호
- **민감 정보 토큰화**: 비밀번호 재설정, 이메일 변경
- **링크 만료**: 시간 기반 링크 만료

### 4. 스팸 방지
- **링크 신고 시스템**: 사용자 신고 기능
- **관리자 금지 기능**: 스팸 링크/사용자 차단
- **익명 링크 제한**: 설정을 통한 익명 링크 생성 제한

---

## 설정 및 배포

### 1. 환경 변수 설정

#### 기본 설정
```env
PORT=3000
SITE_NAME=Kutt
DEFAULT_DOMAIN=localhost:3000
JWT_SECRET=your-secret-key
```

#### 데이터베이스 설정
```env
DB_CLIENT=better-sqlite3
DB_FILENAME=db/data
# 또는 PostgreSQL/MySQL 설정
DB_HOST=localhost
DB_PORT=5432
DB_NAME=kutt
DB_USER=postgres
DB_PASSWORD=password
```

#### Redis 설정 (선택사항)
```env
REDIS_ENABLED=true
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
```

#### 이메일 설정
```env
MAIL_ENABLED=true
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USER=your-email@gmail.com
MAIL_PASSWORD=your-password
MAIL_FROM=Kutt <noreply@kutt.it>
```

### 2. Docker 배포

#### 지원되는 구성
- **기본**: SQLite 데이터베이스
- **Redis 포함**: SQLite + Redis
- **PostgreSQL**: PostgreSQL + Redis
- **MariaDB**: MariaDB + Redis

#### Docker Compose 예시
```yaml
version: '3.8'
services:
  kutt:
    image: kutt/kutt:latest
    ports:
      - "3000:3000"
    environment:
      - JWT_SECRET=your-secret
    volumes:
      - ./custom:/kutt/custom
```

### 3. 커스터마이징

#### 파일 구조
```
custom/
├── css/          # 커스텀 스타일
├── images/       # 커스텀 이미지
└── views/        # 커스텀 템플릿
```

#### 테마 지원
- CSS 오버라이드
- 로고 및 파비콘 교체
- HTML 템플릿 커스터마이징

---

## 성능 최적화

### 1. 데이터베이스 최적화
- **인덱스 활용**: 자주 조회되는 컬럼에 인덱스 적용
- **연결 풀링**: 데이터베이스 연결 풀 관리
- **쿼리 최적화**: Knex.js를 통한 효율적인 쿼리

### 2. 캐싱 전략
- **Redis 캐싱**: 자주 접근되는 데이터 캐싱
- **정적 파일 캐싱**: Express static 미들웨어 활용

### 3. 비동기 처리
- **큐 시스템**: Bull을 이용한 백그라운드 작업
- **비동기 핸들러**: asyncHandler를 통한 에러 처리

---

## 확장성 고려사항

### 1. 마이크로서비스 분리 가능성
- **인증 서비스**: 사용자 관리 및 인증
- **링크 서비스**: URL 단축 및 리디렉션
- **통계 서비스**: 분석 및 리포팅
- **알림 서비스**: 이메일 및 알림

### 2. 수평 확장
- **로드 밸런서**: 여러 인스턴스 운영
- **데이터베이스 샤딩**: 대용량 데이터 분산
- **CDN 활용**: 정적 파일 배포

### 3. 모니터링 및 로깅
- **APM 도구**: 성능 모니터링
- **로그 집중화**: 중앙화된 로그 관리
- **알림 시스템**: 장애 알림

---

## 결론

Kutt는 잘 구조화된 URL 단축 서비스로, 다음과 같은 장점을 가지고 있습니다:

### 강점
1. **모듈화된 아키텍처**: 명확한 책임 분리
2. **다양한 데이터베이스 지원**: 유연한 배포 옵션
3. **강력한 보안**: 다층 보안 구조
4. **확장 가능성**: 플러그인 및 커스터마이징 지원
5. **완전한 기능**: 엔터프라이즈급 기능 제공

### 개선 가능 영역
1. **API 문서화**: OpenAPI/Swagger 통합
2. **테스트 커버리지**: 단위 테스트 및 통합 테스트
3. **메트릭 수집**: 상세한 성능 지표
4. **국제화**: 다국어 지원

이 프로젝트는 현대적인 웹 개발 패턴을 잘 따르고 있으며, 실제 운영 환경에서 사용할 수 있는 완성도 높은 솔루션입니다.